!function(){"use strict";var t="https://static.popmechanic.ru",n=function(){var t=window.PopMechanic.tabVisibility;"visible"===document.visibilityState?t.lastVisibilityStart=Date.now():t.lastVisibilityStart&&(t.duration+=Date.now()-t.lastVisibilityStart)},i=document,e=function(){var t=window.PopMechanic.tabVisibility;t.duration=0,t.lastVisibilityStart="visible"===document.visibilityState?Date.now():null},o=function(){if("hidden"===document.visibilityState)return window.PopMechanic.tabVisibility.duration;var t=Date.now()-window.PopMechanic.tabVisibility.lastVisibilityStart;return window.PopMechanic.tabVisibility.duration+t},r=window.navigator.userAgent.toLowerCase();function a(t){return-1!==r.indexOf(t)}var s=a("windows"),c=!s&&a("android"),d=c&&a("mobile"),l=!s&&a("iphone"),u=a("ipod"),h=s&&a("phone"),p=a("blackberry")||a("bb10")||a("rim"),f=p&&!a("tablet"),m=(a("(mobile;")||a("(tablet;"))&&a("; rv:"),v=m&&a("mobile"),w=a("meego"),g=d||l||u||h||f||v||w,b=a("ipad")||navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/MacIntel/.test(navigator.platform),_=c&&!a("mobile"),I=p&&a("tablet"),y=s&&a("touch")&&!h,P=m&&a("tablet"),U=!g&&(b||_||I||y||P),E=!U&&!g;function D(){return g?"mobile":U?"tablet":E?"desktop":"unknown"}var M=function(t){if(!window.PopMechanic.sampleSent){window.PopMechanic.sampleSent=!0;var n=o(),i=navigator&&navigator.connection&&navigator.connection.downlink,e=D();(new Image).src="https://personalization-speedtest-stable.mindbox.ru/check-reco?result=failure"+(t?"&reason="+t:"")+"&t="+n+"&dl="+("number"==typeof i?i:"unknown")+"&dt="+e+"&c="+window.PopMechanic.client+"&url="+encodeURIComponent(location.pathname)+"&_="+ +Date.now()}},x=function(t,n,i,e,o){void 0===n&&(n=void 0),void 0===i&&(i=500),void 0===e&&(e=2e3),void 0===o&&(o=15);var r=null;return new Promise((function(a){var s=function(i,c){if(void 0!==window[t]&&(void 0===n||window[t]===n))return r=window[t],void a(r);c>=o?a(null):setTimeout((function(){var t=2*i;s(t>e?e:t,c+1)}),i)};s(i,0)}))},W=function(t,n){void 0===t&&(t=[]),void 0===n&&(n=2e3);var i=new Promise((function(t){setTimeout(t,n)}));return Promise.race([Promise.all(t),i])},S=x("mindboxInitialized",!0),T=x("mindboxBatchedModulesInitialized",!0),A=function(){var t=x("mindbox",void 0,150,1e3,3);return W([t,S,T],1300)},C="https://personalization-web-stable.mindbox.ru",V=C+"/web/forms/",R=function(t){var n=t.method;void 0===n&&(n="GET");var i=t.url,e=t.options;return new Promise((function(t,o){var r=e&&e.withCredentials||!1,a=e&&e.retryLimit||3,s=function(){var e=new XMLHttpRequest;e.responseType="json",e.withCredentials=r,e.open(n,i),e.send(),e.onload=function(){200===e.status&&t(e.response),o(e)},e.onerror=function(){if((0===e.status||e.status>=500)&&a>0)return a--,void s();o(e)}};s()}))},H=function(t){var n=function(t){return t.split(".").length>2?t.replace(/(^www\.)/gi,""):t}(t),i=n.split("."),e=[];e.push(n);for(var o=0;o<i.length-1;o++){var r="*"+i.slice(o,i.length).join(".");e.push(r)}return e},N=function(t){var n=Date.now(),i=new URLSearchParams(window.location.search),e=Math.floor("true"==i.get("mindbox_nocache")?n/1e3:n/3e5);return R(Object.assign({},t,{url:t.url+"?_="+e}))},k=function(t){return new Promise((function(n,i){var e=[];t.forEach((function(t,n){return e.push(new O(t,(function(){return function(t){e.slice(t+1).forEach((function(t){return t.cancel()}))}(n)})))}));var o=e.map((function(t){return t.execute()}));return Promise.all(o).then((function(t){var e=t.findIndex((function(t){var n=t.error,i=t.cancelled;return!n&&!i}));e>-1&&n({data:t[e].data,index:e});var o=t[t.length-1];i(o.error)}))}))},O=function(t,n){this.promise=t,this._onResolve=n,this.cancel=this.cancel.bind(this),this.execute=this.execute.bind(this)};O.prototype._onResolve=function(){},O.prototype.cancel=function(){return Promise.resolve({cancelled:!0})},O.prototype.execute=function(){var t=this;return new Promise((function(n){t.cancel=function(){return n({cancelled:!0})},t.promise.then((function(i){t._onResolve(),n({data:i})})).catch((function(t){return n({error:t})}))}))};var z=function(t){var n=t.s3Server,i=t.clientId,e=t.endpointId,o=t.hostname,r=t.s3Fetch;void 0===r&&(r=N),this._s3server=n,this._clientId=i,this._endpointId=e?e.toLowerCase():void 0,this._hostname=o,this._s3Fetch=r,this._getUrlWithDomainAndEndpoint=this._getUrlWithDomainAndEndpoint.bind(this),this._getUrlWithEndpoint=this._getUrlWithEndpoint.bind(this),this._getUrlWithDomain=this._getUrlWithDomain.bind(this),this._getDefaultUrl=this._getDefaultUrl.bind(this),this._getApiUrlsWithEndpoint=this._getApiUrlsWithEndpoint.bind(this),this._getApiUrlsWithoutEndpoint=this._getApiUrlsWithoutEndpoint.bind(this)};z.prototype._getUrlWithDomainAndEndpoint=function(t){return this._s3server+"/init/"+this._clientId+"/domain_and_endpoint/"+this._endpointId+":"+t},z.prototype._getUrlWithEndpoint=function(){return this._s3server+"/init/"+this._clientId+"/endpoint/"+this._endpointId},z.prototype._getNoEndpointUrl=function(){return this._s3server+"/init/"+this._clientId+"/no_endpoint"},z.prototype._getUrlWithDomain=function(t){return this._s3server+"/init/"+this._clientId+"/domain/"+t},z.prototype._getNoDomainUrl=function(){return this._s3server+"/init/"+this._clientId+"/no_domain"},z.prototype._getDefaultUrl=function(){return this._s3server+"/init/"+this._clientId+"/default"},z.prototype._getApiUrlsWithEndpoint=function(){var t=this,n=H(this._hostname),i=[];return n.forEach((function(n){var e=t._getUrlWithDomainAndEndpoint(n);i.push(e)})),i.push(this._getUrlWithEndpoint()),i.push(this._getNoEndpointUrl()),i},z.prototype._getApiUrlsWithoutEndpoint=function(){var t=this,n=H(this._hostname),i=[];return n.forEach((function(n){var e=t._getUrlWithDomain(n);i.push(e)})),i.push(this._getNoDomainUrl()),i},z.prototype.fetch=function(){var t=this,n=[];(n=this._endpointId?this._getApiUrlsWithEndpoint():this._getApiUrlsWithoutEndpoint()).push(this._getDefaultUrl());var i=n.map((function(n){return t._s3Fetch({url:n,method:"HEAD"})}));return k(i).then((function(i){var e=i.index;return t._s3Fetch({url:n[e],method:"GET"})}))};var L=function(t){var n=t.endpointId,i=t.formHash,e=t.clientId;return window.__POPMECHANIC_INIT?Promise.resolve(window.__POPMECHANIC_INIT):i?function(t){var n=t.endpointId,i=t.clientId,e=t.formHash;return R({method:"GET",url:V+e+"/?c="+i+"&domain="+encodeURIComponent(location.host)+(n?"&endpointId="+encodeURIComponent(n):""),options:{withCredentials:!0}})}({endpointId:n,formHash:i,clientId:e}):new z({s3Server:"https://personalization-web-stable.mindbox.ru",clientId:e,endpointId:n,hostname:location.hostname}).fetch()},q=null,F=function(t){return void 0===t&&(t=!0),t&&q?Promise.resolve(q):A().then((function(){if(!window.mindbox)return{endpointId:null,deviceUUID:null};var t=new Promise((function(t){window.mindbox("helpers.getDeviceUUID",(function(n){t(n||null)}))})),n=new Promise((function(t){window.mindbox("personalization.invokeWithActualEndpointId",(function(n){t(n||null)}))}));return Promise.all([n,t]).then((function(t){return{endpointId:t[0],deviceUUID:t[1]}}))})).then((function(t){var n=t.endpointId,i=t.deviceUUID;return L({endpointId:n,clientId:window.PopMechanic.client,formHash:window.PopMechanic.formHash}).then((function(t){return{config:t,deviceUUID:i}})).catch((function(t){return t.status>=400&&M("init-error"),Promise.resolve({deviceUUID:i,config:null})})).then((function(t){return q=t}))}))};!function(){if(!window.PopMechanicMutex){window.PopMechanicMutex=!0;var r=+Date.now(),a=function(t,n){void 0===n&&(n=i);var e=n.getElementById("popmechanic-script");if(!e)for(var o=t.replace(/^https?:\/\//,""),r=n.getElementsByTagName("script"),a=0;a<r.length;a++){var s=r[a];s.src.indexOf(o)>-1&&s.src.indexOf("?c=")>-1&&(e=s)}return e?e.src.split("?c=")[1].split("&")[0]:null}(t);if(a||window.PopMechanic){var s,c=-1!==(s=document.location.toString()).indexOf("pm-test-form=")?s.split("pm-test-form=")[1].split("&")[0]:"";window.PopMechanic=function(t){var n=t.formHash,i=t.clientId,r=t.loadedTs,a=t.initialPopMechanic||{loaded:!1,onLoad:!1,customs:{}};a.client||(a.client=i),a.formHash=n,a.isTesting=!!n,a.dummyIsRequired=location.href.indexOf("pm-dummy")>-1,void 0===a.debugMode&&(a.debugMode="1"===sessionStorage["popmechanic-debug"]),a.loadedTimestamp=r,a.slaRequired=!1,a.sampleSent=!1;var s=function(){a.slaRequired&&(a.sampleSent&&a.loaded||M("timeout"))},c=function(){return setTimeout(s,parseInt("30000",10))};return a.watchdog=c(),a.restartWatchdog=function(){a.slaRequired=!1,a.sampleSent=!1,clearTimeout(a.watchdog),a.watchdog=c()},a.globalUtils={getIntegrationPromise:x,waitPromisesOrDelay:W,getMindboxIsReadyPromise:A,reportFailure:M,getSettings:F,getTabVisibilityDuration:o,resetTabVisibilityDuration:e,getDeviceType:D},a}({formHash:c,clientId:a,loadedTs:r,initialPopMechanic:window.PopMechanic}),window.PopMechanic.initStartedAt=Date.now(),window.PopMechanic.tabVisibility={duration:0,lastVisibilityStart:null},n(),document.addEventListener("visibilitychange",n),F().then((function(n){var i=n.config;i&&i.forms.length&&function(t){var n=t.version,i=t.host,e=document.createElement("script");e.async="async",e.defer="defer",e.charset="utf-8",e.src=i+"/service/v2/forms.js?v="+n;var o=document.createElement("link");o.rel="stylesheet",o.href=i+"/service/styles.css?v="+n,document.head.appendChild(o),document.getElementsByTagName("head")[0].appendChild(e)}({version:"4.39.2",host:t})}))}else console.error("Incorrect setup of Personalization tracker")}}()}();
